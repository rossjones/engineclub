{% extends "base.html" %}
{% load utils depot_tags markup %}
{% block title %}find resources{% endblock %}

{% block body_class %}search{% endblock %}
{% block content %}
    <h1>Search</h1>

        <div class="row">

            <div class="search-form">

<form class="nice form" action="." method="GET" id="search_form">{% csrf_token %}
    <fieldset>
        <legend><span>Type in a place, post code, or words:</span></legend>
             {{ form.as_p }}

        <hr>     
        {% for hidden in form.hidden_fields %}
                {{ hidden }}
        {% endfor %}


        {% for field in form %}
                <label for="id_{{ field.name }}">{{ field.name }}</label> <input type="text" name="{{ field.name }}" value="{{ field.value|default_if_none:'' }}" id="id_{{ field.name }}" class="input-text">
                {{ field.errors }}
            {% if field.errors %}<small class="error">{{ field.errors|join:", " }}</small>{% endif %}

<!--             {{ field.errors }}
            {{ field.label_tag }} {{ field }}
 -->            <!-- <span class="helptext">{{ field.help_text }}</span> -->
        {% endfor %}

<!--         <label for="slider" id="slider_label">Make results more local:</label>
        <span class="helptext">drag slider to the right to make location more important than search text.</span>
 -->            
        <input type="submit" name="result" value="Find items" id="submit_button">
        <!-- input type="submit" name="result" value="Cancel" -->
    </fieldset>
</form>


{% comment %}
                    
                <form class="nice" method="post">
                    <fieldset>
                        <legend><span>Type in a place, post code, or words:</span></legend>

                        <label for="id_post_code">Location</label> <input type="text" name="post_code" value="pollok" id="id_post_code" class="input-text">
<!--                        <span class="helptext">enter a post code or a place name</span>
 -->                    
                        
                        <label for="id_kwords">Search text:</label> <input type="text" name="kwords" id="id_kwords" class="input-text">
<!--                        <span class="helptext">comma separated text (spaces OK)</span>
 -->                    
                        
                        <label for="id_events_only"><input type="checkbox" name="events_only" id="id_events_only">Events only</label> 
                        <span class="helptext"></span>
                    
                        
<!--                        <label for="id_boost_location">Boost location</label> <input type="hidden" name="boost_location" value="30.0" id="id_boost_location">
                        <span class="helptext"></span>
 -->                    

            <!--         <label for="slider" id="slider_label">Make results more local:</label><div id="slider" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all"><div class="ui-slider-range ui-slider-range-min ui-widget-header" style="width: 22.22222222222222%; "></div><a href="#" class="ui-slider-handle ui-state-default ui-corner-all" style="left: 22.22222222222222%; "></a></div>
                    <span class="helptext">drag slider to the right to make location more important than search text.</span>
             -->            
                    <input type="submit" name="result" value="Find items" id="submit_button">
                                
                    </fieldset>

                </form>
{% endcomment %}                

            </div>      

            <div id="map">
                <img src="images/map-01.jpg" alt="">
            </div>      
        </div>

        <div class="row results">
            <h2>Results for 'Pollok'</h2>
            <ul>
                <li>
                    <div class="row">
                    <h3><a href="#">South West Kinship Care Group</a></h3>
                    <div class="location">
                        <h4>Location:</h4>
                        <p>G53 5AB, Greater Pollok, Glasgow City</p>
                    </div>
                    <p>South West Kinship Care Group Meet in The Wedge 1066 Barrhead Rd Pollok Glasgow G53 5AB For information contact: Linda 882 7629 or Terri 07784 753122 email:southwestkinship@yahoo.co.uk Provides advice and ...</p>
                    <p><a href="#top" class="action top">top</a></p>
                    </div>
                </li>
                <li>
                    <h3><a href="#">Pollok Retired Men’s Group</a></h3>
                    <div class="location">
                        <h4>Location:</h4>
                        <p>G53 5DD, Greater Pollok, Glasgow City</p>
                    </div>
                    <p>Pollok Retired Men’s Group Langton Hall, 69 Langton Road, Pollok G53 5DD</p>
                    <p><a href="#top" class="action top">top</a></p>
                </li>
                <li>
                    <h3><a href="#">Rossdale Resource Centre</a></h3>
                    <div class="location">
                        <h4>Location:</h4>
                        <p>G53 6AB, Greater Pollok, Glasgow City</p>
                    </div>
                    <p>Rossdale Resource Centre (Adult Community Mental Health Team, 12 Haughburn Rd, Pollok, Glasgow, G53 6AB, 0141 232 4750 aims to provide care to people suffering from persistent or acute mental ...</p>
                    <p><a href="#top" class="action top">top</a></p>
                </li>
                <li>
                    <h3><a href="#">South West Bridging Service</a></h3>
                    <div class="location">
                        <h4>Location:</h4>
                        <p>G53 6AB, Greater Pollok, Glasgow City</p>
                    </div>
                    <p>South West Bridging Service (6 Haughburn Rd, Glasgow G53 6AB, email info@southwestbridgingservice.co.uk, 0141 585 6852 ) Offer dedicated youth service but if call main number can be directed on. One-stop-shop ...</p>
                    <p><a href="#top" class="action top">top</a></p>
                </li>
                <li>
                    <h3><a href="#">Pollok Library</a></h3>
                    <div class="location">
                        <h4>Location:</h4>
                        <p>G53 6EW, Greater Pollok, Glasgow City</p>
                    </div>
                    <p>Website home page has day-by-day listing of activities. Services include: Adult Literacy and Numeracy classes; Arts and Crafts: session run by professional artists; Bounce And Rhyme: action, Rhyme and Song ...</p>
                    <p><a href="#top" class="action top">top</a></p>
                </li>
                <li>
                    <h3><a href="#">Citizens Advice-Home Visiting Service</a></h3>
                    <div class="location">
                        <h4>Location:</h4>
                        <p>G53 6EW, Greater Pollok, Glasgow City</p>
                    </div>
                    <p>Citizens Advice-Home Visiting Service The CAB also offers a limited home visiting service for residents of Greater Pollok who are disabled, elderly or have carer responsibilities. Please telephone 0141 876 ...</p>
                    <p><a href="#top" class="action top">top</a></p>
                </li>

            </ol>
        </div>
    </div>


{% endblock %}





{% comment %}

<div class="row">
    <div class="twelve columns">

<h1>Find Resources</h1>

<div id="slider"></div>

<form class="nice form" action="." method="GET" id="search_form">{% csrf_token %}
    <fieldset>
        <legend><span>Type in a place, post code, or words:</span></legend>
        {% for hidden in form.hidden_fields %}
                {{ hidden }}
        {% endfor %}
        {% for field in form %}
            {{ field.errors }}
            {{ field.label_tag }} {{ field }}
            <span class="helptext">{{ field.help_text }}</span>
        {% endfor %}

        <label for="slider" id="slider_label">Make results more local:</label>
        <span class="helptext">drag slider to the right to make location more important than search text.</span>
            
        <input type="submit" name="result" value="Find items" id="submit_button">
        <!-- input type="submit" name="result" value="Cancel" -->
    </fieldset>
</form>

<div id="results">
    
  {% if centre %}
    <h2>Closest results for {{ centre.name }}:</h2>
  {% endif %}


<div id="map"></div>

    <ol class="resource-listing">
        {% for result in results %}
            {% with result.resource_result as resource %}
                <li id="resource{{ resource.id }}">
                    <p class="resource-listing-title"><a href="{% url resource object_id=resource.res_id %}">{{ resource.title }}</a></p>
                    {% if resource.event_start %}
                        <p class="event">{{ resource|idx_event_date }}</p>
                    {% endif %}
                    {% if resource.loc_labels %}
                        <ol>
                            {% for loc_label in resource.loc_labels %}
                                <li class="resource-listing-locs">{{ loc_label }}</li>
                            {% endfor %}
                        </ol>
                    {% endif %}
    
                    <div class="resource-description">{{ resource.short_description|truncatewords:30|textile }}</div>

                    <p class="resource-listing-meta">
                        <a class="resource-url" href="{% url resource resource.res_id %}">more details...</a>
                        {% if resource.uri %}
                            | <a href="{{ resource.uri }}">external site...</a>
                        {% endif %}

                        {% if user.is_authenticated %}
                            {% if result.curation %}
                                | <a class="curation-add" href="{% url curation-edit resource.res_id result.curation_index %}">edit curation...</a>
                            {% else %}
                                | <a class="curation-add" href="{% url curation-add resource.res_id %}">create curation...</a>
                            {% endif %}
                        {% endif %}
                        | <a class="resource-report" href="{% url resource-report resource.res_id %}?next={{ here }}">Report Resource</a>
                    </p>

                    {% if user.is_authenticated %}
                    <form action="{% if result.curation %}{% url curation-edit resource.res_id result.curation_index %}{% else %}{% url curation-add resource.res_id %}{% endif %}" class="curation-add" method="post">
                        {% csrf_token %}
                        <fieldset>
                            <legend><span>Curation details:</span></legend>
                            <ol>
                                 {{ result.curation_form.as_ul }}
                            </ol>
                        </fieldset>
                         <fieldset class="submit">
                            <input type="submit" name="result" value="Save item">
                        </fieldset>
                    </form>

                    <form action="{% url resource-report resource.res_id %}?next={{ here }}" class="resource-report" method="post">
                        {% csrf_token %}
                        <fieldset>
                            <legend><span>Report details:</span></legend>
                            <ol>
                                 {{ result.resource_report_form.as_ul }}
                            </ol>
                        </fieldset>
                         <fieldset class="submit">
                            <input type="submit" name="result" value="Save item">
                        </fieldset>
                    </form>
                    {% endif %}

                </li>
            {% endwith %}
        {% empty %}
            <li>no results found</li>
        {% endfor %}
    </ol>
    </div>
</div>

</div>

{% endblock %}

{% block script-extra %}
<script src="/static/js/jquery-ui.custom.min.js" type="text/javascript"></script>
<link type="text/css" href="/static/js/css/themes/base/jquery.ui.all.css" rel="stylesheet" />
<!-- link type="text/css" href="/static/js/css/demosx.css" rel="stylesheet" / -->
<link href="/static/css/token-input-aliss.css" type="text/css" rel="stylesheet">

<script type="text/javascript" src="http://maps.google.com/maps?file=api&v=2&key={{ google_key }}"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/mxn-min.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/mxn.core-min.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/mxn.google.core-min.js"></script>
<script src="/static/js/jquery.tokeninput.js" type="text/javascript"></script>
<!-- <script src="http://openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript" charset="utf-8" src="/static/js/mxn.openlayers.core-min.js"></script>
 -->
<style>
    #slider { width: auto; }

    form.resource-report, form.curation-add {
        display: none;
    }

</style>
{% endblock %}

{% block document-ready %}
var loc = $( "#slider_label" );
var select = $( "#id_boost_location" );
var slider = $( '<div id="slider"></div>' ).insertAfter( loc ).slider({
    min: 10,
    max: 100,
    range: "min",
    value: select.val(),
    slide: function( event, ui ) {
        select.val(ui.value);
        //$("#submit_button").click()
        
    }
});
{% comment %}
    
$('.resource-listing > li').each(function () {
    var $self = $(this);
    var $disclosureButton = $self.find('.resource-listing-meta a.curation-add');
    var $disclosureContent = $self.find('form.curation-add');

    $disclosureContent.hide();
    $disclosureButton.click(function (event) {
        event.preventDefault();
        $disclosureContent.toggle();
        $disclosureButton.toggleClass('selected', $disclosureContent.is(':visible'));
    });


    var $reportButton = $self.find('.resource-listing-meta a.resource-report');
    var $reportContent = $self.find('form.resource-report');

    $reportContent.hide();
    $reportButton.click(function (event) {
        event.preventDefault();
        $reportContent.toggle();
        $reportButton.toggleClass('selected', $reportContent.is(':visible'));
    });

    var $tagsInput = $disclosureContent.find('[name=tags]');
    var $noteInput = $disclosureContent.find('[name=note]');

    // fixes for browser back button- value not set, so tags/note not showing
    if ($noteInput.length)  {
        $noteInput[0].value = $noteInput[0].innerText;
    }
    if ($tagsInput.length)  { 
        $tagsInput[0].value = $tagsInput[0].defaultValue;

        var existingTags = [];
        if ($tagsInput.val() !== "") {
            $.each($tagsInput.val().split(', '), function (i, tag) {
                existingTags.push({id: tag, name: tag});
            });
        }

        $tagsInput.tokenInput('{% url depot.api_handlers.tags %}', {
            minChars: 3,
            onResult: function (results) {
                var typedValue = $disclosureContent.find('.token-input-input-token-aliss input').val();
                var r = [];
                if ($.inArray(typedValue, results.data) == -1) {
                    r.push({id: typedValue, name: typedValue});
                }
                $.each(results.data, function (i, item) {
                    r.push({id: item, name: item});
                });
                return r;
            },
            prePopulate: existingTags,
            queryParam: 'match',
            theme: 'aliss'
        });
     }

    $disclosureContent.submit(function (event) {
        $form = $(this);
        event.preventDefault();
        var action = $form.attr('action');
        var data = $form.serializeArray();
        $.post(action, data, function (data, textStatus, jqXHR) {
            $form.attr('action', data.url);
            $form.find('[name=tags]').val(data.curation.tags.join(', '));
            $form.find('[name=note]').val(data.curation.note);
            $disclosureButton.text('edit curation...');
            $form.hide();

            var $flash = $('<div class="flash" style="background:#ffc;font-weight:bold">Curation saved.</div>');
            $form.before($flash);
            setTimeout(function () {
                $flash.remove();
            }, 4000);
        });
    });
});

{% if results and centre %}

    var centre_pt = new mxn.LatLonPoint({{centre.location.0}}, {{centre.location.1}})
    mapstraction = new mxn.Mapstraction('map','google');
    //mapstraction = new mxn.Mapstraction('map','openlayers');
    mapstraction.addMarker( new mxn.Marker(centre_pt));

    {% for res in results %}{% for loc in res.resource_result.pt_location %}
        advancedMarker({{loc|get_lat}}, {{loc|get_lon}}, '<p><a href="{% url resource res.resource_result.res_id %}">{{ res.resource_result.title }}</a></p>')
    {% endfor %}{% endfor %}

    function advancedMarker(lat, lon, info) {
        mapstraction.addMarkerWithData(new mxn.Marker( new mxn.LatLonPoint(lat, lon)),{
            infoBubble : info,
            label : "tooltip",
            marker : 3,
            icon : "/static/media/img/ymarker_or.png",
            iconSize : [25,25],
            draggable : false,
            hover : true
        });
    };

    mapstraction.addControls({
        pan: true, 
        zoom: 'small',
        map_type: true 
    });
    
    mapstraction.setCenterAndZoom(centre_pt, 9);

{% endif %}
{% endblock %}


{% block main-content-class %}onecol{% endblock %}
{% block content %}

<h1>Find Resources</h1>

<div class="usermessage">
    <p>This is a demonstration only, and shows how any web site might access the ALISS engine.</p>
    <p>ALISS demonstration data is mainly from <a href="/groups/4d9b9a4489cb16665c000002/">Grampian</a> and <a href="/groups/4d9fbd5789cb1673fb000000/">Renfrewshire</a>. Searches in other areas may produce strange results!</p>

</div>

<div id="slider"></div>

<form class="form" action="." method="GET" id="search_form">{% csrf_token %}
    <fieldset>
        <legend><span>Resource details:</span></legend>
        {# <div class="ui-widget"> #}
        
        <ol>
             {{ form.as_ul }}
            <li><label for="slider" id="slider_label">Make results more local:</label>
            <span class="helptext">drag slider to the right to make location more important than search text.</span>
            </li>
        </ol>
        {# </div> #}
    </fieldset>

     <fieldset class="submit">
        <input type="submit" name="result" value="Find items" id="submit_button">
        <!-- input type="submit" name="result" value="Cancel" -->
    </fieldset>
</form>

<div id="results">
    
  {% if centre %}
    <h2>Closest results for {{ centre.name }}:</h2>
  {% endif %}

    <ol class="resource-listing">
        {% for result in results %}
            {% with result.resource_result as resource %}
                <li id="resource{{ resource.id }}">
                    <p class="resource-listing-title"><a href="{% url resource object_id=resource.res_id %}">{{ resource.title }}</a></p>
                    {% if resource.event_start %}
                        <p class="event">{{ resource|idx_event_date }}</p>
                    {% endif %}
                    {% if resource.loc_labels %}
                        <ol>
                            {% for loc_label in resource.loc_labels %}
                                <li class="resource-listing-locs">{{ loc_label }}</li>
                            {% endfor %}
                        </ol>
                    {% endif %}

                    <p>{{ resource.short_description|truncatewords:30 }}</p>
                    <p class="resource-listing-meta">
                        <a class="resource-url" href="{% url resource resource.res_id %}">more details...</a>
                        {% if resource.uri %}
                            | <a href="{{ resource.uri }}">external site...</a>
                        {% endif %}

                        {% if user.is_authenticated %}
                            {% if result.curation %}
                                | <a class="curation-add" href="{% url curation-edit resource.res_id result.curation_index %}">edit curation...</a>
                            {% else %}
                                | <a class="curation-add" href="{% url curation-add resource.res_id %}">create curation...</a>
                            {% endif %}
                            
                        | <a class="resource-report" href="{% url resource-report resource.res_id %}?next={{ here }}">Report Resource</a>


                        {% endif %}
                    </p>

                    {% if user.is_authenticated %}
                    <form action="{% if result.curation %}{% url curation-edit resource.res_id result.curation_index %}{% else %}{% url curation-add resource.res_id %}{% endif %}" class="curation-add" method="post">
                        {% csrf_token %}
                        <fieldset>
                            <legend><span>Curation details:</span></legend>
                            <ol>
                                 {{ result.curation_form.as_ul }}
                            </ol>
                        </fieldset>
                         <fieldset class="submit">
                            <input type="submit" name="result" value="Save item">
                        </fieldset>
                    </form>

                    <form action="{% url resource-report resource.res_id %}?next={{ here }}" class="resource-report" method="post">
                        {% csrf_token %}
                        <fieldset>
                            <legend><span>Report details:</span></legend>
                            <ol>
                                 {{ result.resource_report_form.as_ul }}
                            </ol>
                        </fieldset>
                         <fieldset class="submit">
                            <input type="submit" name="result" value="Save item">
                        </fieldset>
                    </form>
                        
                    {% endif %}

                </li>
            {% endwith %}
        {% empty %}
            <li>no results found</li>
        {% endfor %}
    </ol>

</div>
<div id="map"></div>

{% endblock %}
{% endcomment %}


